{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://stabiom.local/schemas/run.schema.json",
  "title": "STaBioM Run Config",
  "type": "object",
  "additionalProperties": false,
  "required": ["pipeline_id", "run", "technology", "input", "resources", "params", "output"],
  "properties": {
    "pipeline_id": {
      "type": "string",
      "enum": ["lr_meta", "lr_amp", "sr_meta", "sr_amp"]
    },

    "run": {
      "type": "object",
      "additionalProperties": false,
      "required": ["work_dir", "run_id", "force_overwrite"],
      "properties": {
        "work_dir": { "type": "string", "minLength": 1 },
        "run_id": { "type": "string", "minLength": 1 },
        "force_overwrite": { "type": "integer", "enum": [0, 1] }
      }
    },

    "technology": {
      "type": "string",
      "enum": ["ONT", "PACBIO", "ILLUMINA", "BGI", "IONTORRENT"]
    },

    "specimen": {
      "type": "string",
      "enum": ["vaginal", "gut", "oral", "skin", "other"],
      "default": "other"
    },

    "input": {
      "type": "object",
      "additionalProperties": false,
      "required": ["style"],
      "properties": {
        "style": {
          "type": "string",
          "enum": [
            "FAST5_DIR",
            "FAST5_ARCHIVE",
            "FASTQ_SINGLE",
            "FASTQ_PAIRED",
            "FASTQ_DIR_SINGLE",
            "FASTQ_DIR_PAIRED"
          ]
        },

        "fast5_dir": { "type": "string" },
        "fast5_archive": { "type": "string" },

        "fastq_r1": { "type": "string" },
        "fastq_r2": { "type": "string" },

        "fastq_dir": { "type": "string" }
      }
    },

    "resources": {
      "type": "object",
      "additionalProperties": true,
      "required": ["threads"],
      "properties": {
        "threads": { "type": "integer", "minimum": 1, "maximum": 256 }
      }
    },

    "tools": {
      "type": "object",
      "additionalProperties": true
    },

    "params": {
      "type": "object",
      "additionalProperties": true,
      "required": ["common"],
      "properties": {
        "common": {
          "type": "object",
          "additionalProperties": true,
          "required": ["min_qscore", "remove_host"],
          "properties": {
            "min_qscore": { "type": "integer", "minimum": 0, "maximum": 60 },
            "remove_host": { "type": "integer", "enum": [0, 1] },

            "specimen": {
              "type": "string",
              "enum": ["vaginal", "gut", "oral", "skin", "other"]
            }
          }
        }
      }
    },

    "qiime2": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "sample_id": { "type": "string" },

        "primers": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "forward": { "type": "string" },
            "reverse": { "type": "string" }
          }
        },

        "classifier": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "qza": { "type": "string" }
          }
        },

        "dada2": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "trim_left_f": { "type": "integer", "minimum": 0 },
            "trim_left_r": { "type": "integer", "minimum": 0 },
            "trunc_len_f": { "type": "integer", "minimum": 0 },
            "trunc_len_r": { "type": "integer", "minimum": 0 },
            "n_threads": { "type": "integer", "minimum": 0 }
          }
        },

        "diversity": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "sampling_depth": { "type": "integer", "minimum": 0 },
            "metadata_tsv": { "type": "string" }
          }
        }
      }
    },

    "valencia": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": { "type": "string", "enum": ["auto", "on", "off"], "default": "auto" },

        "repo_url": { "type": "string" },
        "ref_csv": { "type": "string" },
        "valencia_py": { "type": "string" }
      }
    },

    "output": {
      "type": "object",
      "additionalProperties": false,
      "required": ["selected"],
      "properties": {
        "selected": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "export_dir": { "type": "string" }
      }
    }
  },

  "allOf": [
    {
      "if": { "properties": { "pipeline_id": { "enum": ["lr_meta", "lr_amp"] } } },
      "then": {
        "properties": {
          "technology": { "enum": ["ONT", "PACBIO"] },
          "input": {
            "allOf": [
              {
                "if": { "properties": { "style": { "const": "FAST5_DIR" } }, "required": ["style"] },
                "then": { "required": ["fast5_dir"] }
              },
              {
                "if": { "properties": { "style": { "const": "FAST5_ARCHIVE" } }, "required": ["style"] },
                "then": { "required": ["fast5_archive"] }
              },
              {
                "if": { "properties": { "style": { "const": "FASTQ_SINGLE" } }, "required": ["style"] },
                "then": { "required": ["fastq_r1"] }
              }
            ]
          }
        }
      }
    },

    {
      "if": { "properties": { "pipeline_id": { "enum": ["sr_meta", "sr_amp"] } } },
      "then": {
        "properties": {
          "technology": { "enum": ["ILLUMINA", "BGI", "IONTORRENT"] },
          "input": {
            "allOf": [
              {
                "if": { "properties": { "style": { "const": "FASTQ_SINGLE" } }, "required": ["style"] },
                "then": { "required": ["fastq_r1"] }
              },
              {
                "if": { "properties": { "style": { "const": "FASTQ_PAIRED" } }, "required": ["style"] },
                "then": { "required": ["fastq_r1", "fastq_r2"] }
              }
            ]
          }
        }
      }
    },

    {
      "if": { "properties": { "pipeline_id": { "const": "sr_amp" } } },
      "then": {
        "properties": {
          "input": {
            "properties": {
              "style": { "enum": ["FASTQ_SINGLE", "FASTQ_PAIRED"] }
            }
          }
        }
      }
    }
  ]
}
